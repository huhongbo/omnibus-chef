#!/bin/sh

cd /opt/chef-server/embedded/service/logstash/
exec 2>&1
# Need to set LOGSTASH_HOME and HOME so sincedb will work
LOGSTASH_HOME="/opt/chef-server/embedded/service/logstash"
GC_OPTS="-XX:+UseParallelOldGC"
JAVA_OPTS="-server -Xms<%= node['chef-server']['logstash']['xms'] %> -Xmx<%= node['chef-server']['logstash']['xmx'] %> -Djava.io.tmpdir=$LOGSTASH_HOME/tmp/"
LOGSTASH_OPTS="agent -f <%= node['chef_server']['logstash']['dir'] %>/etc/logstash.conf -l <%= node['chef-server']['logstash']['log_directory'] %>/logstash.log"
<% if node['chef-server']['logstash']['agent']['debug'] -%>
LOGSTASH_OPTS="$LOGSTASH_OPTS -v"
<% end -%>
exec chpst -P -U <%= node['chef_server']['user']['username1'] %> -u <%= node['chef_server']['user']['username1'] %> /usr/bin/env PATH=/opt/chef-server/embedded/bin:/opt/chef-server/bin:/opt/chef-server/embedded/jre/bin:$PATH JAVA_HOME=/opt/chef-server/embedded/jre java $JAVA_OPTS $GC_OPTS -jar $LOGSTASH_HOME/logstash.jar $LOGSTASH_OPTS
